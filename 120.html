<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·åŠ©æ‰‹ - ç—‡çŠ¶+å›¾ç‰‡ç²¾å‡†åˆ†æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36B37E',
                        warning: '#FFAB00',
                        danger: '#FF5630',
                        neutral: '#F5F7FA',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .symptom-tag { @apply px-3 py-1.5 rounded-full text-sm cursor-pointer transition-all; }
            .symptom-tag-active { @apply bg-primary text-white; }
            .disease-tag { @apply px-2 py-0.5 rounded text-xs font-medium; }
            .progress-bar {
                height: 4px;
                background: linear-gradient(90deg, #165DFF 0%, #36B37E 100%);
                width: 0%;
                transition: width 1s ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center text-primary">
                <i class="fa fa-medkit mr-2"></i>å¥åº·åŠ©æ‰‹
            </h1>
            <div class="flex items-center space-x-3">
                <button id="helpBtn" class="p-2 rounded-full hover:bg-gray-100 transition">
                    <i class="fa fa-question-circle text-gray-500"></i>
                </button>
                <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-100 transition">
                    <i class="fa fa-moon-o text-gray-500"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="flex-1 container mx-auto px-4 py-6">
        <!-- å›¾ç‰‡è¯Šæ–­åŒºåŸŸï¼ˆæ¢å¤ï¼‰ -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-camera text-primary mr-2"></i>å›¾ç‰‡åˆ†æï¼ˆå¯é€‰ï¼‰
                </h2>
                <span class="px-2 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary">çš®è‚¤/èˆŒè‹”/çš®ç–¹ç­‰è§†è§‰ç—‡çŠ¶</span>
            </div>

            <!-- å›¾ç‰‡ç±»å‹é€‰æ‹©å™¨ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-600 mb-2">è¯·é€‰æ‹©å›¾ç‰‡ç±»å‹ï¼ˆå¦‚ä¸Šä¼ ï¼‰ï¼š</label>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <button class="image-type-btn active px-3 py-2 border border-primary bg-primary/5 rounded-lg text-sm flex items-center justify-center hover:bg-primary/10 transition" data-type="skin">
                        <i class="fa fa-cut mr-1"></i>çš®è‚¤ç—‡çŠ¶
                    </button>
                    <button class="image-type-btn px-3 py-2 border border-gray-200 rounded-lg text-sm flex items-center justify-center hover:bg-gray-50 transition" data-type="tongue">
                        <i class="fa fa-fire mr-1"></i>èˆŒè‹”çŠ¶æ€
                    </button>
                    <button class="image-type-btn px-3 py-2 border border-gray-200 rounded-lg text-sm flex items-center justify-center hover:bg-gray-50 transition" data-type="rash">
                        <i class="fa fa-bug mr-1"></i>çš®ç–¹è¡¨ç°
                    </button>
                    <button class="image-type-btn px-3 py-2 border border-gray-200 rounded-lg text-sm flex items-center justify-center hover:bg-gray-50 transition" data-type="other">
                        <i class="fa fa-ellipsis-h mr-1"></i>å…¶ä»–
                    </button>
                </div>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="border-2 border-dashed border-gray-200 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="imageUploadArea">
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡è‡³æ­¤å¤„ä¸Šä¼ ï¼ˆå¯é€‰ï¼‰</p>
                <p class="text-xs text-gray-400 mt-1">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®åˆ†è¾¨ç‡â‰¥500Ã—500px</p>
                <div class="mt-3 text-xs text-gray-500">
                    <i class="fa fa-info-circle mr-1"></i>æç¤ºï¼šé€‚ç”¨äºçš®è‚¤çº¢è‚¿ã€èˆŒè‹”å¼‚å¸¸ã€çš®ç–¹ç­‰éœ€è¦è§†è§‰åˆ¤æ–­çš„ç—‡çŠ¶
                </div>
            </div>

            <!-- é¢„è§ˆä¸åˆ†æåŒº -->
            <div id="imagePreviewContainer" class="mt-4 hidden">
                <div class="flex flex-wrap justify-between items-start mb-3">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-700">é¢„è§ˆå›¾ï¼š</span>
                        <span id="imageTypeLabel" class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 ml-2">çš®è‚¤ç—‡çŠ¶</span>
                    </div>
                    <button id="removeImage" class="text-gray-500 text-sm hover:text-danger transition">
                        <i class="fa fa-trash-o mr-1"></i>ç§»é™¤å›¾ç‰‡
                    </button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="sm:w-1/3">
                        <img id="previewImage" class="rounded-lg border border-gray-100 shadow-sm w-full object-cover" style="max-height: 220px;">
                    </div>
                    
                    <div class="sm:w-2/3">
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-600 mb-1">è¡¥å……ç—‡çŠ¶æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                            <textarea id="symptomDesc" rows="2" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary" placeholder="ä¾‹å¦‚ï¼šçš®ç–¹å‡ºç°2å¤©ï¼Œä¼´éšç˜™ç—’..."></textarea>
                        </div>
                        
                        <button id="diagnoseImage" class="bg-primary text-white px-5 py-2.5 rounded-lg hover:bg-primary/90 transition flex items-center">
                            <i class="fa fa-search-plus mr-2"></i>åˆ†æå›¾ç‰‡ç—‡çŠ¶
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†æè¿›åº¦æ¡ï¼ˆéšè—ï¼‰ -->
            <div id="analysisProgress" class="mt-4 hidden">
                <p class="text-sm text-gray-600 mb-1 flex items-center">
                    <i class="fa fa-spinner fa-spin mr-1"></i>æ­£åœ¨åˆ†æå›¾ç‰‡ç—‡çŠ¶...
                </p>
                <div class="w-full bg-gray-100 rounded-full overflow-hidden">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
            </div>
        </div>

        <!-- ç—‡çŠ¶å¿«é€Ÿé€‰æ‹© -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
            <h2 class="text-lg font-semibold mb-4">å¸¸è§ç—‡çŠ¶å¿«é€Ÿé€‰æ‹©</h2>
            <div class="flex flex-wrap gap-2">
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="å¤´ç—›">å¤´ç—›</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="å‘çƒ­">å‘çƒ­</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="èƒƒç—›">èƒƒç—›</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="å’³å—½">å’³å—½</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="è…¹æ³»">è…¹æ³»</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="çš®ç–¹">çš®ç–¹</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="ä¹åŠ›">ä¹åŠ›</button>
                <button class="symptom-btn bg-gray-100 px-3 py-1.5 rounded-full text-sm" data-symptom="å¤´æ™•">å¤´æ™•</button>
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-sm p-5 flex-1 flex flex-col h-[500px]">
            <h2 class="text-lg font-semibold mb-4">ç—‡çŠ¶åˆ†æ</h2>
            
            <!-- èŠå¤©å†…å®¹åŒº -->
            <div id="chatContainer" class="flex-1 overflow-y-auto mb-4 p-2 space-y-4">
                <div class="flex items-start">
                    <div class="bg-primary/10 p-2 rounded-full mr-3 mt-1">
                        <i class="fa fa-robot text-primary"></i>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-2xl rounded-tl-none max-w-[85%]">
                        <p class="text-gray-700">æ‚¨å¥½ï¼è¯·æè¿°æ‚¨çš„ç—‡çŠ¶ï¼ˆå“ªæ€•åªè¯´ä¸€ä¸ªè¯ï¼‰ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡åˆ†æçš®è‚¤/èˆŒè‹”ç­‰ç—‡çŠ¶ï¼Œæˆ‘ä¼šä¸ºæ‚¨åˆ†æå¯èƒ½çš„åŸå› ~</p>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="border-t border-gray-100 pt-4">
                <div class="flex">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="ä¾‹å¦‚ï¼šå¤´ç—› / æœ‰ç‚¹å‘çƒ§ / èƒƒä¸èˆ’æœ..." 
                        class="flex-1 px-4 py-2.5 rounded-l-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
                    >
                    <button id="sendButton" class="bg-primary text-white px-5 py-2.5 rounded-r-lg hover:bg-primary/90 transition">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å£°æ˜ -->
    <footer class="bg-white border-t border-gray-100 py-3 mt-6">
        <div class="container mx-auto px-4 text-center text-xs text-gray-500">
            <p>âš ï¸ å£°æ˜ï¼šæœ¬å·¥å…·ä»…æä¾›åˆæ­¥åˆ†æï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚å¦‚æœ‰ä¸é€‚ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚</p>
        </div>
    </footer>

    <script>
        // å…¨å±€å˜é‡
        let currentImageType = 'skin'; // é»˜è®¤å›¾ç‰‡ç±»å‹
        let currentSymptom = null;     // å½“å‰é€‰ä¸­ç—‡çŠ¶

        // æ ¸å¿ƒï¼šåŸºç¡€ç—…å› åº“ï¼ˆç—‡çŠ¶å°‘ä¹Ÿèƒ½ç»™å‡ºç—…å› ï¼‰
        const basicDiseaseDB = {
            å¤´ç—›: [
                { name: "ç´§å¼ æ€§å¤´ç—›", common: "æœ€å¸¸è§ï¼Œä¸å‹åŠ›ã€ç–²åŠ³ã€å§¿åŠ¿ä¸è‰¯ç›¸å…³", advice: "ä¼‘æ¯ã€æŒ‰æ‘©é¢ˆéƒ¨ã€é¿å…é•¿æ—¶é—´ä½å¤´" },
                { name: "åå¤´ç—›", common: "å•ä¾§æåŠ¨æ€§ç–¼ç—›ï¼Œå¯èƒ½ä¼´æ¶å¿ƒ", advice: "é¿å…‰ä¼‘æ¯ï¼Œå¿…è¦æ—¶æœç”¨æ­¢ç—›è¯" },
                { name: "ç¡çœ ä¸è¶³", common: "ç†¬å¤œæˆ–ç¡çœ è´¨é‡å·®ç›´æ¥å¼•èµ·", advice: "è¡¥å……ç¡çœ ï¼Œè§„å¾‹ä½œæ¯" },
                { name: "é«˜è¡€å‹", common: "è¡€å‹éª¤å‡æ—¶å‡ºç°ï¼Œä¸­è€å¹´éœ€æ³¨æ„", advice: "ç›‘æµ‹è¡€å‹ï¼ŒéµåŒ»å˜±ç”¨è¯" }
            ],
            å‘çƒ­: [
                { name: "æ™®é€šæ„Ÿå†’", common: "æœ€å¸¸è§ï¼Œä¼´é¼»å¡ã€æµæ¶•", advice: "å¤šå–æ¸©æ°´ï¼Œä¼‘æ¯1-3å¤©å¯ç¼“è§£" },
                { name: "ç—…æ¯’æ„ŸæŸ“", common: "æµæ„Ÿã€æ–°å† ç­‰ï¼Œå¯èƒ½ä¼´å…¨èº«é…¸ç—›", advice: "å¯¹ç—‡é€€çƒ­ï¼Œå¿…è¦æ—¶æŠ—ç—…æ¯’æ²»ç–—" },
                { name: "ç»†èŒæ„ŸæŸ“", common: "å¦‚æ‰æ¡ƒä½“ç‚ã€è‚ºç‚ï¼Œå¯èƒ½ä¼´å¯’æˆ˜", advice: "éœ€æŠ—ç”Ÿç´ æ²»ç–—ï¼ŒåŠæ—¶å°±åŒ»" },
                { name: "ç–«è‹—ååº”", common: "æ¥ç§ç–«è‹—å1-2å¤©å‡ºç°ï¼Œä½çƒ­ä¸ºä¸»", advice: "ç‰©ç†é™æ¸©ï¼Œè§‚å¯Ÿ24å°æ—¶" }
            ],
            èƒƒç—›: [
                { name: "é¥®é£Ÿä¸å½“", common: "åƒè¾£ã€ç”Ÿå†·æˆ–è¿‡é¥±å¼•èµ·", advice: "æ¸…æ·¡é¥®é£Ÿï¼Œçƒ­æ•·è…¹éƒ¨" },
                { name: "æ…¢æ€§èƒƒç‚", common: "åå¤éšç—›ï¼Œé¤åæ˜æ˜¾", advice: "é¿å…åˆºæ¿€é£Ÿç‰©ï¼Œå¯æœèƒƒé»è†œä¿æŠ¤å‰‚" },
                { name: "èƒƒç—‰æŒ›", common: "çªç„¶ç»ç—›ï¼Œä¸å—å‡‰æˆ–ç´§å¼ ç›¸å…³", advice: "å–æ¸©çƒ­æ°´ï¼Œè…¹éƒ¨ä¿æš–" },
                { name: "èƒ†å›Šé—®é¢˜", common: "å³ä¸Šè…¹ç–¼ç—›ï¼Œå¯èƒ½æ”¾å°„åˆ°èƒŒéƒ¨", advice: "ä½è„‚é¥®é£Ÿï¼ŒåŠæ—¶åšè…¹éƒ¨Bè¶…" }
            ],
            å’³å—½: [
                { name: "ä¸Šå‘¼å¸é“æ„ŸæŸ“", common: "æ„Ÿå†’ä¼´å‘ï¼ŒåˆæœŸå¹²å’³", advice: "å¤šå–æ¸©æ°´ï¼Œå¿…è¦æ—¶æ­¢å’³è¯" },
                { name: "æ”¯æ°”ç®¡ç‚", common: "å’³å—½ä¼´å’³ç—°ï¼Œå¯èƒ½æŒç»­1-2å‘¨", advice: "åŒ–ç—°æ²»ç–—ï¼Œé¿å…çƒŸé›¾åˆºæ¿€" },
                { name: "è¿‡æ•ååº”", common: "æ¥è§¦ç²‰å°˜ã€èŠ±ç²‰åå¹²å’³", advice: "è¿œç¦»è¿‡æ•åŸï¼ŒæœæŠ—è¿‡æ•è¯" },
                { name: "åæµæ€§é£Ÿç®¡ç‚", common: "å¹³å§æ—¶å’³å—½åŠ é‡ï¼Œä¼´åé…¸", advice: "ç¡å‰2å°æ—¶ç¦é£Ÿï¼ŒæŠ¬é«˜åºŠå¤´" }
            ],
            è…¹æ³»: [
                { name: "æ€¥æ€§èƒƒè‚ ç‚", common: "é¥®é£Ÿä¸æ´å¼•èµ·ï¼Œä¼´è…¹ç—›", advice: "è¡¥æ°´é˜²è„±æ°´ï¼Œæ¸…æ·¡é¥®é£Ÿ" },
                { name: "æ¶ˆåŒ–ä¸è‰¯", common: "åƒå¤šæˆ–æ²¹è…»åå‡ºç°ï¼Œç³ŠçŠ¶ä¾¿", advice: "å‡å°‘è¿›é£Ÿé‡ï¼Œæœç”¨åŠ©æ¶ˆåŒ–è¯" },
                { name: "è‚ é“èŒç¾¤å¤±è°ƒ", common: "æŠ—ç”Ÿç´ ä½¿ç”¨åå‡ºç°", advice: "è¡¥å……ç›Šç”ŸèŒï¼Œé¿å…ç”Ÿå†·" }
            ],
            çš®ç–¹: [
                { name: "è¿‡æ•ååº”", common: "æ¥è§¦æ–°è¡£ç‰©ã€é£Ÿç‰©åå‡ºç°ï¼Œä¼´ç˜™ç—’", advice: "è¿œç¦»è¿‡æ•åŸï¼ŒæœæŠ—ç»„èƒºè¯" },
                { name: "èšŠè™«å®å’¬", common: "å•ä¸ªæˆ–å¤šä¸ªå°çº¢ç‚¹ï¼Œä¸­å¿ƒæœ‰å’¬ç—•", advice: "æ¶‚ç‚‰ç”˜çŸ³æ´—å‰‚æ­¢ç—’" },
                { name: "æ¹¿ç–¹", common: "å¯¹ç§°åˆ†å¸ƒï¼Œçº¢æ–‘ä¸˜ç–¹ï¼Œåå¤å‘ä½œ", advice: "é¿å…æŠ“æŒ ï¼Œå¤–ç”¨ä¿æ¹¿éœœ" }
            ],
            ä¹åŠ›: [
                { name: "ç–²åŠ³ç»¼åˆå¾", common: "ä¼‘æ¯åä»ä¹åŠ›ï¼Œä¸å‹åŠ›ç›¸å…³", advice: "è§„å¾‹ä½œæ¯ï¼Œé€‚åº¦è¿åŠ¨" },
                { name: "è´«è¡€", common: "ä¼´é¢è‰²è‹ç™½ã€å¤´æ™•", advice: "æŸ¥è¡€å¸¸è§„ï¼Œè¡¥å……é“å‰‚æˆ–å¶é…¸" },
                { name: "ç”²çŠ¶è…ºåŠŸèƒ½å‡é€€", common: "ä¼´æ€•å†·ã€é£Ÿæ¬²å·®", advice: "æŸ¥ç”²çŠ¶è…ºåŠŸèƒ½ï¼ŒéµåŒ»å˜±æ²»ç–—" }
            ],
            å¤´æ™•: [
                { name: "ä½“ä½æ€§ä½è¡€å‹", common: "çªç„¶ç«™èµ·æ—¶å¤´æ™•ï¼Œå‡ ç§’åç¼“è§£", advice: "èµ·èº«ç¼“æ…¢ï¼Œé¿å…çªç„¶ç«™ç«‹" },
                { name: "é¢ˆæ¤ç—…", common: "ä¼´é¢ˆéƒ¨ä¸é€‚ï¼Œè½¬å¤´æ—¶åŠ é‡", advice: "å‡å°‘ä½å¤´ï¼Œåšé¢ˆæ¤æ“" },
                { name: "ä½è¡€ç³–", common: "ç©ºè…¹æ—¶å‡ºç°ï¼Œä¼´å¿ƒæ…Œå‡ºæ±—", advice: "åŠæ—¶è¡¥å……ç³–åˆ†ï¼Œè§„å¾‹è¿›é¤" }
            ]
        };

        // ç—‡çŠ¶å…³é”®è¯æ˜ å°„ï¼ˆé€‚é…ä¸æ ‡å‡†æè¿°ï¼‰
        const symptomAlias = {
            "å¤´ç–¼": "å¤´ç—›", "å‘çƒ§": "å‘çƒ­", "èƒƒä¸èˆ’æœ": "èƒƒç—›", "è‚šå­ç–¼": "èƒƒç—›",
            "å’³å—½äº†": "å’³å—½", "æ‹‰è‚šå­": "è…¹æ³»", "èº«ä¸Šç—’": "çš®ç–¹", "æ²¡åŠ›æ°”": "ä¹åŠ›", "å¤´æœ‰ç‚¹æ™•": "å¤´æ™•"
        };

        // å›¾ç‰‡è§†è§‰ç—‡çŠ¶-ç—…å› å…³è”åº“
        const imageDiseaseDB = {
            skin: [
                { name: "æ¥è§¦æ€§çš®ç‚", common: "çš®è‚¤å‘çº¢ã€ç˜™ç—’ï¼Œè¾¹ç•Œè¾ƒæ¸…æ™°", advice: "é¿å…æ¥è§¦è¿‡æ•åŸï¼Œå¤–ç”¨ç³–çš®è´¨æ¿€ç´ è½¯è†" },
                { name: "æ¹¿ç–¹", common: "çº¢æ–‘ã€ä¸˜ç–¹ã€æ¸—å‡ºï¼Œåå¤å‘ä½œ", advice: "ä¿æ¹¿æŠ¤ç†ï¼Œé¿å…æŠ“æŒ ï¼Œå£æœæŠ—ç»„èƒºè¯" },
                { name: "è™«å’¬çš®ç‚", common: "å­¤ç«‹çº¢è‰²ä¸˜ç–¹ï¼Œä¸­å¿ƒæœ‰å’¬ç‚¹", advice: "æ¶‚æ¸…å‡‰æ­¢ç—’è¯è†ï¼Œé¿å…æ”æŠ“" }
            ],
            tongue: [
                { name: "è„¾è™šæ¹¿ç››", common: "èˆŒè‹”è–„ç™½å¾®è…»ï¼ŒèˆŒè¾¹æœ‰é½¿ç—•", advice: "å±±è¯ã€èŒ¯è‹“ç…®ç²¥ï¼Œæœå‚è‹“ç™½æœ¯æ•£" },
                { name: "èƒƒçƒ­", common: "èˆŒçº¢è‹”é»„ï¼Œå£å¹²å£è‹¦", advice: "æ¸…æ·¡é¥®é£Ÿï¼Œé¿å…è¾›è¾£ï¼Œæœç‰›é»„æ¸…èƒƒä¸¸" },
                { name: "é˜´è™š", common: "èˆŒçº¢å°‘è‹”ï¼Œå£å¹²å’½ç‡¥", advice: "é“¶è€³ç™¾åˆæ±¤ï¼Œæœå…­å‘³åœ°é»„ä¸¸" }
            ],
            rash: [
                { name: "è¨éº»ç–¹", common: "é£å›¢æ ·çš®ç–¹ï¼Œç˜™ç—’æ˜æ˜¾ï¼Œé€Ÿèµ·é€Ÿé€€", advice: "æœæŠ—ç»„èƒºè¯ï¼Œé¿å…å†·çƒ­åˆºæ¿€" },
                { name: "æ¯›å›Šç‚", common: "çº¢è‰²ä¸˜ç–¹ï¼Œä¸­å¿ƒæœ‰è„“ç‚¹ï¼Œè½»å¾®ç–¼ç—›", advice: "ä¿æŒæ¸…æ´ï¼Œå¤–ç”¨æŠ—ç”Ÿç´ è½¯è†" },
                { name: "ç«ç‘°ç³ ç–¹", common: "æ¤­åœ†å½¢çº¢æ–‘ï¼Œé•¿è½´ä¸çš®çº¹ä¸€è‡´", advice: "é¿å…çƒ­æ°´çƒ«æ´—ï¼Œå¤–ç”¨ç‚‰ç”˜çŸ³æ´—å‰‚" }
            ],
            other: [
                { name: "è‰¯æ€§çš®è‚¤è¡¨ç°", common: "æ— æ˜æ˜¾ç‚ç—‡ã€ç˜™ç—’ï¼Œå½¢æ€è§„åˆ™", advice: "è§‚å¯Ÿå˜åŒ–ï¼Œé¿å…åˆºæ¿€ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†" },
                { name: "å¾…æ˜ç¡®çš®ç–¹", common: "ç—‡çŠ¶ä¸å…¸å‹ï¼Œéœ€ç»“åˆæ›´å¤šä¿¡æ¯", advice: "è®°å½•å˜åŒ–ï¼Œå¿…è¦æ—¶çš®è‚¤ç§‘å°±è¯Š" }
            ]
        };

        // DOMå…ƒç´ 
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const symptomBtns = document.querySelectorAll('.symptom-btn');
        const imageInput = document.getElementById('imageInput');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const previewImage = document.getElementById('previewImage');
        const removeImage = document.getElementById('removeImage');
        const diagnoseImage = document.getElementById('diagnoseImage');
        const analysisProgress = document.getElementById('analysisProgress');
        const progressBar = document.getElementById('progressBar');
        const imageTypeBtns = document.querySelectorAll('.image-type-btn');
        const imageTypeLabel = document.getElementById('imageTypeLabel');
        const symptomDesc = document.getElementById('symptomDesc');

        // ç—‡çŠ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        symptomBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // æŒ‰é’®æ ·å¼åˆ‡æ¢
                symptomBtns.forEach(b => b.classList.remove('bg-primary', 'text-white'));
                symptomBtns.forEach(b => b.classList.add('bg-gray-100', 'text-gray-700'));
                this.classList.add('bg-primary', 'text-white');
                this.classList.remove('bg-gray-100', 'text-gray-700');
                
                // å¡«å……è¾“å…¥æ¡†
                currentSymptom = this.dataset.symptom;
                userInput.value = currentSymptom;
                userInput.focus();
            });
        });

        // å›¾ç‰‡ç±»å‹é€‰æ‹©äº‹ä»¶
        imageTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                imageTypeBtns.forEach(b => {
                    b.classList.remove('active', 'border-primary', 'bg-primary/5');
                    b.classList.add('border-gray-200');
                });
                btn.classList.add('active', 'border-primary', 'bg-primary/5');
                btn.classList.remove('border-gray-200');
                currentImageType = btn.dataset.type;
                // æ›´æ–°å›¾ç‰‡ç±»å‹æ ‡ç­¾
                const typeMap = {
                    skin: 'çš®è‚¤ç—‡çŠ¶',
                    tongue: 'èˆŒè‹”çŠ¶æ€',
                    rash: 'çš®ç–¹è¡¨ç°',
                    other: 'å…¶ä»–ç±»å‹'
                };
                imageTypeLabel.textContent = typeMap[currentImageType];
            });
        });

        // å›¾ç‰‡ä¸Šä¼ ç›¸å…³äº‹ä»¶
        imageUploadArea.addEventListener('click', () => imageInput.click());
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('border-primary', 'bg-primary/5');
        });
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('border-primary', 'bg-primary/5');
        });
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('border-primary', 'bg-primary/5');
            if (e.dataTransfer.files[0]) handleImageUpload(e.dataTransfer.files[0]);
        });
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleImageUpload(file);
        });

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            const validTypes = ['image/jpeg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                addSystemMessage('è¯·ä¸Šä¼ JPGæˆ–PNGæ ¼å¼çš„å›¾ç‰‡', 'error');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                addSystemMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                previewImage.src = event.target.result;
                imagePreviewContainer.classList.remove('hidden');
                // é‡ç½®é€‰ä¸­çš„ç—‡çŠ¶ï¼ˆå›¾ç‰‡åˆ†æä¼˜å…ˆï¼‰
                symptomBtns.forEach(b => b.classList.remove('bg-primary', 'text-white'));
                symptomBtns.forEach(b => b.classList.add('bg-gray-100', 'text-gray-700'));
                currentSymptom = null;
            };
            reader.readAsDataURL(file);
        }

        // ç§»é™¤å›¾ç‰‡
        removeImage.addEventListener('click', () => {
            imageInput.value = '';
            imagePreviewContainer.classList.add('hidden');
            previewImage.src = '';
            symptomDesc.value = '';
        });

        // å›¾ç‰‡åˆ†ææŒ‰é’®äº‹ä»¶
        diagnoseImage.addEventListener('click', () => {
            imagePreviewContainer.classList.add('hidden');
            analysisProgress.classList.remove('hidden');
            progressBar.style.width = '0%';

            // æ¨¡æ‹Ÿåˆ†æè¿›åº¦
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(generateImageDiagnosis, 800);
                }
                progressBar.style.width = `${progress}%`;
            }, 500);
        });

        // ç”Ÿæˆå›¾ç‰‡åˆ†æç»“æœ
        function generateImageDiagnosis() {
            analysisProgress.classList.add('hidden');
            progressBar.style.width = '0%';

            const desc = symptomDesc.value.trim() || 'æœªæä¾›é¢å¤–æè¿°';
            const diseases = imageDiseaseDB[currentImageType];
            
            let reply = `
                <div class="mb-3">
                    <h3 class="text-sm font-medium text-gray-800 mb-2">${imageTypeLabel.textContent}åˆ†æç»“æœ</h3>
                    <p class="text-sm text-gray-700">åŸºäºå›¾ç‰‡åŠæè¿°ï¼ˆ${desc}ï¼‰ï¼Œå¯èƒ½çš„åŸå› åŠå»ºè®®ï¼š</p>
                </div>
                <div class="space-y-2 mb-3">
            `;

            diseases.forEach((disease, index) => {
                reply += `
                    <div class="bg-gray-50 p-2.5 rounded-lg text-sm">
                        <div class="flex items-center mb-1">
                            <span class="disease-tag bg-primary/10 text-primary mr-2">${index + 1}. ${disease.name}</span>
                            <span class="text-xs text-gray-500">${disease.common}</span>
                        </div>
                        <div class="text-gray-700">ğŸ’¡ ${disease.advice}</div>
                    </div>
                `;
            });

            reply += `
                </div>
                <div class="p-2 bg-blue-50 rounded-lg text-xs text-blue-700">
                    æ³¨ï¼šå›¾ç‰‡åˆ†æä»…ä¸ºåˆæ­¥æ¨æµ‹ï¼Œè‹¥ç—‡çŠ¶æŒç»­æˆ–åŠ é‡ï¼Œå»ºè®®åˆ°å¯¹åº”ç§‘å®¤ï¼ˆçš®è‚¤ç§‘/æ¶ˆåŒ–ç§‘ç­‰ï¼‰å°±è¯Šç¡®è¯Šã€‚
                </div>
            `;

            addMessageToChat(reply, 'ai');
            // é‡ç½®å›¾ç‰‡é¢„è§ˆ
            imagePreviewContainer.classList.add('hidden');
            previewImage.src = '';
            symptomDesc.value = '';
        }

        // å‘é€æ–‡å­—æ¶ˆæ¯
        function sendMessage() {
            let message = userInput.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessageToChat(message, 'user');
            userInput.value = '';

            // æ ‡å‡†åŒ–ç—‡çŠ¶å…³é”®è¯
            let mainSymptom = message;
            Object.keys(symptomAlias).forEach(alias => {
                if (message.includes(alias)) mainSymptom = symptomAlias[alias];
            });
            const allSymptoms = Object.keys(basicDiseaseDB);
            for (let s of allSymptoms) {
                if (message.includes(s)) {
                    mainSymptom = s;
                    break;
                }
            }

            // ç”Ÿæˆå›å¤
            let reply = '';
            if (basicDiseaseDB[mainSymptom]) {
                const diseases = basicDiseaseDB[mainSymptom];
                reply = `
                    <div class="mb-2">
                        <p class="text-sm font-medium">å¯èƒ½çš„åŸå› åŠå»ºè®®ï¼š</p>
                    </div>
                    <div class="space-y-2">
                `;
                diseases.forEach((disease, index) => {
                    reply += `
                        <div class="bg-gray-50 p-2.5 rounded-lg text-sm">
                            <div class="flex items-center mb-1">
                                <span class="disease-tag bg-primary/10 text-primary mr-2">${index + 1}. ${disease.name}</span>
                                <span class="text-xs text-gray-500">${disease.common}</span>
                            </div>
                            <div class="text-gray-700">ğŸ’¡ ${disease.advice}</div>
                        </div>
                    `;
                });
                reply += `</div>`;
            } else {
                // å…œåº•é€šç”¨å›å¤
                reply = `
                    <div class="bg-gray-50 p-3 rounded-lg text-sm">
                        <p class="mb-2">æ ¹æ®å¸¸è§æƒ…å†µï¼Œå¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š</p>
                        <ul class="list-disc pl-5 space-y-1 text-gray-700">
                            <li>ç”Ÿç†å› ç´ ï¼šè¿‡åº¦ç–²åŠ³ã€ç¡çœ ä¸è¶³ã€å‹åŠ›è¿‡å¤§</li>
                            <li>é¥®é£Ÿå› ç´ ï¼šè¿›é£Ÿä¸è§„å¾‹ã€é£Ÿç‰©åˆºæ¿€æˆ–è¿‡æ•</li>
                            <li>ç¯å¢ƒå› ç´ ï¼šæ¸©åº¦å˜åŒ–ã€ç©ºæ°”æ±¡æŸ“ã€æ¥è§¦è¿‡æ•åŸ</li>
                            <li>æ½œåœ¨ç–¾ç—…ï¼šå¦‚æŒç»­ä¸ç¼“è§£ï¼Œå»ºè®®è§‚å¯Ÿæ˜¯å¦ä¼´éšå…¶ä»–ç—‡çŠ¶ï¼ˆå¦‚å‘çƒ­ã€ç–¼ç—›ï¼‰</li>
                        </ul>
                    </div>
                `;
            }

            // æ¨¡æ‹Ÿå»¶è¿Ÿå›å¤
            setTimeout(() => addMessageToChat(reply, 'ai'), 1000);
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ˆé”™è¯¯/æç¤ºï¼‰
        function addSystemMessage(text, type = 'info') {
            const messageDiv = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600';
            
            messageDiv.className = `flex justify-center my-2`;
            messageDiv.innerHTML = `
                <div class="${bgColor} px-3 py-1.5 rounded-full text-xs flex items-center">
                    <i class="fa fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-1"></i>${text}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒº
        function addMessageToChat(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start ${sender === 'user' ? 'justify-end' : ''}`;

            const bubbleClass = sender === 'user' 
                ? 'bg-primary text-white rounded-2xl rounded-tr-none' 
                : 'bg-gray-50 rounded-2xl rounded-tl-none';

            messageDiv.innerHTML = sender === 'user' 
                ? `
                    <div class="max-w-[85%] order-1">
                        <div class="${bubbleClass} p-3">
                            <p>${content}</p>
                        </div>
                    </div>
                    <div class="bg-primary/10 p-2 rounded-full ml-3 mt-1 order-2">
                        <i class="fa fa-user text-primary"></i>
                    </div>
                `
                : `
                    <div class="bg-primary/10 p-2 rounded-full mr-3 mt-1">
                        <i class="fa fa-robot text-primary"></i>
                    </div>
                    <div class="max-w-[85%]">
                        <div class="${bubbleClass} p-3 text-gray-800">
                            ${content}
                        </div>
                    </div>
                `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // äº‹ä»¶ç»‘å®š
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

        // å¸®åŠ©æŒ‰é’®
        document.getElementById('helpBtn').addEventListener('click', () => {
            addSystemMessage('å¯ç›´æ¥æè¿°ç—‡çŠ¶ï¼ˆå¦‚"å¤´ç—›"ï¼‰ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡åˆ†æçš®è‚¤/èˆŒè‹”ç­‰è§†è§‰ç—‡çŠ¶ï¼Œæ— éœ€è¯¦ç»†æè¿°ä¹Ÿèƒ½è·å–å¯èƒ½åŸå› ~', 'info');
        });

        // ä¸»é¢˜åˆ‡æ¢
        document.getElementById('themeToggle').addEventListener('click', (e) => {
            const icon = e.currentTarget.querySelector('i');
            const isDark = icon.classList.contains('fa-sun-o');
            
            if (isDark) {
                // æµ…è‰²æ¨¡å¼
                icon.classList.replace('fa-sun-o', 'fa-moon-o');
                document.body.classList.remove('bg-gray-900', 'text-white');
                document.querySelectorAll('.bg-white').forEach(el => el.classList.remove('bg-gray-800'));
                document.querySelectorAll('.bg-gray-50').forEach(el => el.classList.remove('bg-gray-800'));
                document.querySelectorAll('.text-gray-800').forEach(el => el.classList.remove('text-gray-200'));
            } else {
                // æ·±è‰²æ¨¡å¼
                icon.classList.replace('fa-moon-o', 'fa-sun-o');
                document.body.classList.add('bg-gray-900', 'text-white');
                document.querySelectorAll('.bg-white').forEach(el => el.classList.add('bg-gray-800'));
                document.querySelectorAll('.bg-gray-50').forEach(el => el.classList.add('bg-gray-800'));
                document.querySelectorAll('.text-gray-800').forEach(el => el.classList.add('text-gray-200'));
            }
        });
    </script>
</body>
</html>
